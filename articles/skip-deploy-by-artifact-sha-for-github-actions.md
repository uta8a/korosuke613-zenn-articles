---
title: "æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä¿å­˜ãƒ»æ¯”è¼ƒã—ã¦ä½™è¨ˆãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã‚ãªã„ã‚ˆã†ã«ã™ã‚‹ for GitHub Actions"
emoji: "â­ï¸"
type: "tech"
topics: ["GitHubActions", "GitHubPages", "ShellScript"]
published: true
publication_name: "cybozu_ept"
user_defined: {"publish_link": "https://zenn.dev/cybozu-ept/articles/skip-deploy-by-artifact-sha-for-github-actions"}
published_at: "2023-12-01 07:00"
---

ã‚¿ã‚¤ãƒˆãƒ«é€šã‚Šã§ã™ã€‚GitHub Actions ã«ãŠã„ã¦ã€æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä¿å­˜ãƒ»æ¯”è¼ƒã—ã¦ä½™è¨ˆãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã‚ãªã„ã‚ˆã†ã«ã™ã‚‹æ–¹æ³•ã‚’è¨˜ã—ã¾ã™ã€‚

:::message
ã“ã®è¨˜äº‹ã¯ [GitHub Actions Advent Calendar 2023](https://qiita.com/advent-calendar/2023/github-actions) ã® 1 æ—¥ç›®ã®è¨˜äº‹ã§ã™ğŸ„
æ˜æ—¥ã¯ [Kyome](https://twitter.com/Kyomesuke) ã•ã‚“ã«ã‚ˆã‚‹ã€ŒGitHub Actions ã® Workflow Dispatch å®Ÿè¡Œæ™‚ã«è‡ªå‹•ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæœ‰ç„¡ã‚’æŒ‡å®šã™ã‚‹ã€ãŒäºˆå®šã•ã‚Œã¦ã„ã¾ã™ã€‚æ¥½ã—ã¿ï¼ğŸ¤¶
:::


# TL;DR
- å¯¾è±¡
  - ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ GitHub Actions ã§è¡Œã£ã¦ã„ã‚‹
  - ä½™è¨ˆãªãƒ‡ãƒ—ãƒ­ã‚¤ã¯ã—ãŸããªã„
- é™çš„ã‚µã‚¤ãƒˆã®ãƒ“ãƒ«ãƒ‰æ™‚ã«æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤(sha256)ã‚’è¨ˆç®—ã—ã¦ã€å‰å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã¨åŒã˜ã§ã‚ã‚Œã°ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹
- ãƒ•ã‚¡ã‚¤ãƒ« 1 ã¤ 1 ã¤ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã€å…¨ãƒãƒƒã‚·ãƒ¥å€¤ã‹ã‚‰ã•ã‚‰ã«ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã™ã‚‹
  - ã‚³ãƒãƒ³ãƒ‰ `find <æˆæœç‰©ã®ã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹> -type f -print0 | sort --zero-terminated | xargs -0 sha256sum | cut -d ' ' -f 1 | sha256sum | cut -d ' ' -f 1`
- ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥å€¤ã¯ GitHub Actions ã® Variables ã«ä¿å­˜ã™ã‚‹
  - GitHub CLI ã§ Variables ã‚’å–å¾—ãƒ»æ›´æ–°ã™ã‚‹
- åŒã˜ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§åŒã˜æˆæœç‰©ã«ãªã‚‰ãªã„å ´åˆã¯ã•ã‚‰ã«ä¸€å·¥å¤«ãŒã„ã‚‹ã¨æ€ã†

# èƒŒæ™¯

åƒ•ã¯è‡ªåˆ†ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸(https://korosuke613.dev)ã‚’ GitHub Actions ã§ãƒ“ãƒ«ãƒ‰ã—ã€GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™ã€‚

ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ–ãƒ©ãƒ³ãƒ(main) ã«ãƒãƒ¼ã‚¸å¾Œã€æ¬¡ã®æµã‚Œã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ã€‚


```mermaid
---
title: deploy workflow
---

flowchart LR
    A[build] --> B[deploy]
    B --> C[scraping]
    subgraph ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å¾Œå‡¦ç†
    C --> D[VRT init]
    end
```

![](/images/skip-deploy-by-artifact-sha-for-github-actions/deploy_workflow_timeline.png)
*ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œä¾‹[^togire]*

[^togire]: é€”åˆ‡ã‚ŒãŸç·šã®å…ˆã«ã¯å¤±æ•—æ™‚ã®é€šçŸ¥ã‚¸ãƒ§ãƒ–ã¨ã‹ãŒã‚ã‚Šã¾ã™ãŒã€ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã»ã¼é–¢ä¿‚ãªã„ã®ã§ä»Šå›ã¯çœç•¥ã—ã¾ã™

ãã‚Œãã‚Œã®ã‚¸ãƒ§ãƒ–ã®èª¬æ˜ã¨å¤§ä½“ã‹ã‹ã‚‹æ™‚é–“ã¯æ¬¡ã®é€šã‚Šã§ã™ã€‚

1. buildï¼ˆç´„ 90 ç§’ï¼‰: é™çš„ã‚µã‚¤ãƒˆã®ãƒ“ãƒ«ãƒ‰
2. deployï¼ˆç´„ 20 ç§’ï¼‰: GitHub Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
3. scrapingï¼ˆç´„ 70 ç§’ï¼‰: å…¨æ–‡æ¤œç´¢ç”¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆ[^scraping]ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã®å¾Œå‡¦ç†ï¼‰
4. VRT initï¼ˆç´„ 50 ç§’ï¼‰: Visual Regression Testing ç”¨ã®ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®å½±[^vrt_init]ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã®å¾Œå‡¦ç†ï¼‰

[^scraping]: Argolia ã®ãƒ„ãƒ¼ãƒ«ä½¿ã£ã¦ã¾ã™ https://github.com/korosuke613/homepage-2nd/blob/116cfe6a44b0356934c2718868b05efcadb4c291/.github/workflows/scraping.yaml
[^vrt_init]: ãƒã‚¸ã§ã‚¹ã‚¯ã‚·ãƒ§æ’®ã£ã¦ä¿å­˜ã—ã¦ã‚‹ã ã‘ https://github.com/korosuke613/homepage-2nd/blob/116cfe6a44b0356934c2718868b05efcadb4c291/.github/workflows/vrt-init.yaml

**ç¾çŠ¶ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹ãªã©ã®æˆæœç‰©ã«å½±éŸ¿ã®ãªã„å¤‰æ›´ã‚’å…¥ã‚ŒãŸã ã‘ã§ã‚‚ãƒ‡ãƒ—ãƒ­ã‚¤ãŒèµ°ã£ã¦ã—ã¾ã„ã¾ã™ã€‚**

**å€‹äººçš„ã«ã¯ç„¡é§„ã«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆãƒªã‚½ãƒ¼ã‚¹ã¯ä½¿ã„ãŸãã‚ã‚Šã¾ã›ã‚“ï¼ˆæ–™é‡‘çš„ã«ã‚‚ã€GitHub ã¸ã®è² è·çš„ã«ã‚‚ï¼‰ã€‚**

ä¸Šè¨˜ã®å®Ÿè¡Œä¾‹ã®å ´åˆã€81 + 11 + 66 + 47 = 205 ç§’ï¼ˆ3 åˆ† 25 ç§’ï¼‰ã¯ä¸è¦ãªãƒ‡ãƒ—ãƒ­ã‚¤ã®ãŸã‚ã«ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚
ã¾ãŸã€GitHub Actions ã¯åˆ†å˜ä½ã®èª²é‡‘ã¨ãªã£ã¦ãŠã‚Šã€ã‚¸ãƒ§ãƒ–ã”ã¨ã«ç§’ãŒåˆ‡ã‚Šä¸Šã’ã‚‰ã‚ŒãŸåˆ†ãŒèª²é‡‘ã®å¯¾è±¡ã«ãªã‚Šã¾ã™ã€‚

> GitHub rounds the minutes and partial minutes each job uses up to the nearest whole minute.
> https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions

ãã®ãŸã‚ã€ä¸Šè¨˜ã®å®Ÿè¡Œä¾‹ã®å ´åˆã€2 + 1 + 2 + 1 = 6 åˆ†ã¨ã€è¦‹ãŸç›®ã® 2 å€ã®æ™‚é–“ãŒèª²é‡‘å¯¾è±¡ã¨ãªã£ã¦ã—ã¾ã„ã¾ã™[^public_repo]ã€‚
ã“ã“ã‚‰è¾ºã®åˆ‡ã‚Šä¸Šã’ã®è©±ã¯ [GitHub Actionsã§ä¸¦åˆ—å‡¦ç†ã‚’ä½œã£ã¦ã„ã¦ãƒ’ãƒ¤ãƒƒã¨ã—ãŸè©± - ã‚†ã‚‹ã‚Šã¨](https://khasegawa.hatenablog.com/entry/2022/11/14/100000) ã‚’èª­ã‚€ã¨ãƒ’ãƒ¤ãƒƒã¨ã—ã¾ã™ã€‚

æˆæœç‰©ã«å½±éŸ¿ã®ãªã„å¤‰æ›´ã«å¯¾ã—ã¦ã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ Actions ã®å®Ÿè¡Œæ™‚é–“ã‚’ç¯€ç´„ã—ãŸã„ã§ã™ã€‚

[^public_repo]: ã¨ã¯è¨€ãˆåƒ•ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã¯ public ãƒªãƒã‚¸ãƒˆãƒªãªã®ã§ã€æ–™é‡‘é¢ã¯ã‚ã¾ã‚Šè€ƒãˆãªãã¦ã‚‚è‰¯ã„ã®ã§ã™ãŒã€‚

# ç†æƒ³

ç†æƒ³ã¯ã€æˆæœç‰©ãŒæœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä½¿ã‚ã‚ŒãŸæˆæœç‰©ã¨ä¸€è‡´ã—ã¦ã„ãŸå ´åˆã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã“ã¨ã§ã™ã€‚
æˆæœç‰©ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã«ã€build ã‚¸ãƒ§ãƒ–ã¯å¿…ãšè¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```mermaid
---
title: '[ç†æƒ³] deploy workflowï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ä¸è¦ã®å ´åˆï¼‰'
---

flowchart LR
    classDef skipped fill:#FFF,stroke-dasharray:3,stroke:#000;
    style HH fill:#FFF,stroke-dasharray:3,stroke:#000;

    A[build] -.-> B[deploy]:::skipped
    B -.-> C[scraping]:::skipped
    subgraph HH[ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å¾Œå‡¦ç†]
        C -.-> D[VRT init]:::skipped
    end
```


# ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
æˆæœç‰©ãŒæœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã®ã‚‚ã®ã¨ä¸€è‡´ã—ã¦ã‚‹ã‹ã©ã†ã‹ã‚’ç¢ºèªã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æˆæœç‰©ä¸€å€‹ä¸€å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒä¸€è‡´ã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã®ã¯ã„ã‚ã‚“ãªæ„å‘³ã§å¤§å¤‰ãªã®ã§ã€ä»Šå›ã¯æˆæœç‰©å…¨ä½“ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
**æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨ã€æ–°ãŸã«è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸€è‡´ã—ã¦ã„ã‚Œã°ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®æˆæœç‰©ã¨åŒç­‰ã§ã‚ã‚‹ã¨åˆ¤æ–­ã§ãã¾ã™ã€‚**

æœ€æ–°ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¯ GitHub Actions ã® Variables ã«ä¿å­˜ã—ã¦ãŠãã¾ã™ã€‚

ãƒ‡ãƒ—ãƒ­ã‚¤ã®å…¨ä½“ã®æµã‚Œã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

```mermaid
---
title: deploy workflow
---

flowchart TB
    classDef noteclass fill:#fff5ad,stroke:#decc93;

    subgraph build[build job]
        D[ãƒ“ãƒ«ãƒ‰] --> E[æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤è¨ˆç®—]
        E --> F[/ãƒãƒƒã‚·ãƒ¥å€¤ã‚’`GITHUB_OUTPUT`ã«ä¿å­˜/]
    end
    I[(GitHub Actions Variables)]
    G[(GITHUB_OUTPUT)]
    F ---|write: ãƒãƒƒã‚·ãƒ¥å€¤| G[(GITHUB_OUTPUT)]
    L ---|write: ãƒãƒƒã‚·ãƒ¥å€¤| I
    G ---|read: ãƒãƒƒã‚·ãƒ¥å€¤| H
    I ---|read: ãƒãƒƒã‚·ãƒ¥å€¤| H
    G -.- NOTE1[ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å†…ã§\nãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œä¸­ã®ã¿ä¿æŒ]:::noteclass
    I -.- NOTE2[ãƒªãƒã‚¸ãƒˆãƒªå†…ã§æ°¸ç¶šçš„ã«ä¿æŒ]:::noteclass
    subgraph deploy[deploy job]
        H{build jobã§\nè¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥å€¤ã¨\nVariablesã«\nä¿å­˜ã•ã‚ŒãŸãƒãƒƒã‚·ãƒ¥å€¤ã‚’\næ¯”è¼ƒ}
        H -->|ä¸ä¸€è‡´| J[ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—]
        H -->|ä¸€è‡´| K[GitHub Pages ã¸æˆæœç‰©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤]
        K --> L[/æ–°ãŸãªãƒãƒƒã‚·ãƒ¥å€¤ã‚’Variablesã«ä¸Šæ›¸ãä¿å­˜/]
    end
    build --> deploy
```

å®Ÿéš›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯ https://github.com/korosuke613/homepage-2nd/blob/2bda9f3d6b1c73d4fedccb464f3d6e2e750270a5/.github/workflows/pages.yml ã«ã‚ã‚Šã¾ã™ã€‚

# Build job

https://github.com/korosuke613/homepage-2nd/blob/2bda9f3d6b1c73d4fedccb464f3d6e2e750270a5/.github/workflows/pages.yml#L26-L61

## æˆæœç‰©ç”Ÿæˆ

å˜ç´”ã«æˆæœç‰©ã‚’ç”Ÿæˆã—ã¾ã™ã€‚
åƒ•ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸ã§ã¯ Astro ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚`astro build` ã§æˆæœç‰©ãŒ `./dist` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚æœ€çµ‚çš„ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹éš›ã‚‚ `./dist` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ä¸­èº«ãŒ GitHub Pages ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚

## æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤è¨ˆç®—

æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
å…ˆã®ã‚¹ãƒ†ãƒƒãƒ—ã§ `./dist` ã«æˆæœç‰©ãŒã§ããŸã®ã§ã€`./dist` ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

```sh:ãƒãƒƒã‚·ãƒ¥å€¤è¨ˆç®—éƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰
set -x  # å¾Œã®ãƒ‘ã‚¤ãƒ—ã®å‡¦ç†ãŒã©ã“ã¾ã§é€²ã‚“ã ã‹ã‚ã‹ã‚Šã‚„ã™ãã™ã‚‹ãŸã‚ã« -x ã™ã‚‹
SHA256_OUTPUT=$(find ./dist -type f -print0 | \  # å®Ÿéš›ã«ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã™ã‚‹éƒ¨åˆ†
  sort --zero-terminated | \
  xargs -0 sha256sum | \
  cut -d ' ' -f 1 | \
  sha256sum | \
  cut -d ' ' -f 1)
set +x  # -x ã‚’è§£é™¤
echo "artifacts=$SHA256_OUTPUT" >> $GITHUB_OUTPUT  # GITHUB_OUTPUT ã«ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ç™»éŒ²
```

`SHA256_OUTPUT=$(...` ã‹ã‚‰è¤‡æ•°è¡Œã«ã‚ãŸã£ã¦ã‚³ãƒãƒ³ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã¦ã„ã¾ã™ã€‚
ä¸€è¡Œãšã¤è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

### å„ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŠ½å‡º
`find ./dist -type f -print0` ã§ `./dist` å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†å¸°çš„ã«æ¢ç´¢ã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’ç©ºæ–‡å­—ï¼ˆ`NUL`ï¼‰ã§åŒºåˆ‡ã£ã¦å‡ºåŠ›ã—ã¾ã™ã€‚
`-print0` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒç©ºæ–‡å­—ã§åŒºåˆ‡ã‚‰ã‚Œã¾ã™ã€‚

ãã®ã‚ã¨ã€`find` çµæœã‚’é–“é•ã„ãªãåŒã˜é †ç•ªã¨ã™ã‚‹ãŸã‚ã« `sort --zero-terminated` ã§ã‚½ãƒ¼ãƒˆã—ã¾ã™ã€‚
ç©ºæ–‡å­—åŒºåˆ‡ã‚Šã¨ã—ã¦ã„ã‚‹ãŸã‚ã€`-z` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚

> -z, --zero-terminated
Use NUL as record separator.  By default, records in the files are supposed to be separated by the newline characters.  With this option, NUL (Â´\0Â´) is used as a record separator character.
*`man sort` ã‚ˆã‚Š*

```sh:å®Ÿè¡Œä¾‹
â¯ find ./dist -type f -print0 | sort --zero-terminated
./dist/.well-known/nostr.json./dist/_astro/MyIcon.1653682e.js./dist/_astro/_page_.d3b1192e.css./dist/_astro/bath.16c9f48c_3Aprr.png./dist/_astro/bath.16c9f48c_Z13clWU.avif./dist/_astro/bath.16c9f48c_Z2jCfaR.webp./dist/_astro/client.2dae202b.js./dist/_astro/danwa.dbf56b02_Z12PHtK.avif./dist/_astro/danwa.dbf56b02_Z2brCk7.png./dist/_astro/danwa.dbf56b02_hzStf.wï¼œçœç•¥ï¼
```

[^find_sort_order]: åŸºæœ¬çš„ã«ä¸€æ„ã«å®šã¾ã‚‹ã£ã½ã„ã‘ã©ã€å¿ƒé…ãªã‚‰ sort å™›ã¾ã›ã¿ãŸã„ãªã“ã¨æ›¸ã„ã¦ã‚‹ã€‚https://serverfault.com/a/181815

### å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—

`xargs -0 sha256sum` ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã”ã¨ã«ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã¾ã™ã€‚
ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒç©ºæ–‡å­—ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€`xargs` ã« `-0` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚

```sh:å®Ÿè¡Œä¾‹
â¯ find ./dist -type f -print0 | sort --zero-terminated | xargs -0 sha256sum
71e1abcbd9ba1c14fff4621341d4f7dbffb35f95e87f52577a32a0176bf29386  ./dist/.well-known/nostr.json
63d5b634d1caa1006c5d4223e5e42bc4fbc1cf0b50de3a15ce6f0df248bc51cf  ./dist/_astro/MyIcon.1653682e.js
d3b1192ec86fad2d7d8932abf026906c6c3b7c9fb590bfd65e6b1315f234345d  ./dist/_astro/_page_.d3b1192e.css
fbb86afd1c27ffb2e287c122ab9edb4fbf0bcdfa120b1b5cd4f309a0d7024b84  ./dist/_astro/bath.16c9f48c_3Aprr.png
f3a4c88e7b130a000ad982a88293d32f21236a22c101c34df87017449c56b346  ./dist/_astro/bath.16c9f48c_Z13clWU.avif
5d314feab50b0ea74defa8e2616cc7cd24775a504270ed0bd0f38ded30783cca  ./dist/_astro/bath.16c9f48c_Z2jCfaR.webp
71da924d07a988742faf7e6f967c77b1a4a7d144e8a441294e10dce950da761a  ./dist/_astro/client.2dae202b.js
b06f2644fa3bd3738feb94ea00cb39132c3a452e6e5f04a311da714b7be4f912  ./dist/_astro/danwa.dbf56b02_Z12PHtK.avif
ï¼œçœç•¥ï¼
```

ã¾ãŸã€`sha256sum` ã®çµæœã¯ `ãƒãƒƒã‚·ãƒ¥å€¤ ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹` ã¨ã„ã†å½¢å¼ã§å‡ºåŠ›ã•ã‚Œã‚‹ãŸã‚ã€ãƒãƒƒã‚·ãƒ¥å€¤ã®ã¿ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚
`cut` ã‚³ãƒãƒ³ãƒ‰ã§å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚·ãƒ¥å€¤ã®ã¿ã‚’å–ã‚Šå‡ºã—ã¾ã™ã€‚

```sh:å®Ÿè¡Œä¾‹
â¯ find ./dist -type f -print0 | sort --zero-terminated | xargs -0 sha256sum | cut -d ' ' -f 1
71e1abcbd9ba1c14fff4621341d4f7dbffb35f95e87f52577a32a0176bf29386
63d5b634d1caa1006c5d4223e5e42bc4fbc1cf0b50de3a15ce6f0df248bc51cf
d3b1192ec86fad2d7d8932abf026906c6c3b7c9fb590bfd65e6b1315f234345d
fbb86afd1c27ffb2e287c122ab9edb4fbf0bcdfa120b1b5cd4f309a0d7024b84
f3a4c88e7b130a000ad982a88293d32f21236a22c101c34df87017449c56b346
5d314feab50b0ea74defa8e2616cc7cd24775a504270ed0bd0f38ded30783cca
71da924d07a988742faf7e6f967c77b1a4a7d144e8a441294e10dce950da761a
b06f2644fa3bd3738feb94ea00cb39132c3a452e6e5f04a311da714b7be4f912
ï¼œçœç•¥ï¼
```

### æœ€çµ‚çš„ãªãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—

`sha256sum | cut -d ' ' -f 1` ã§å„ãƒãƒƒã‚·ãƒ¥å€¤ã‹ã‚‰ã•ã‚‰ã«ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã¾ã™ã€‚

```sh:å®Ÿè¡Œä¾‹
â¯ find ./dist -type f -print0 | sort --zero-terminated | xargs -0 sha256sum | cut -d ' ' -f 1 | sha256sum | cut -d ' ' -f 1
fb768233afcd6c4a9c625bc4828252ad787f3b661c0194b5a9586ca59ef23786
```

è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥å€¤ã¯æœ€çµ‚çš„ã« `echo "artifacts=<ãƒãƒƒã‚·ãƒ¥å€¤>" >> $GITHUB_OUTPUT` ã§ `GITHUB_OUTPUT` ã«ä¿å­˜ã—ã¾ã™ã€‚
`GITHUB_OUTPUT` ã«ä¿å­˜ã™ã‚‹ã“ã¨ã§ã€å¾Œç¶šã‚¸ãƒ§ãƒ–ã‹ã‚‰è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥å€¤ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚


# Deploy job

https://github.com/korosuke613/homepage-2nd/blob/2bda9f3d6b1c73d4fedccb464f3d6e2e750270a5/.github/workflows/pages.yml#L63-L96

## ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨ã®æ¯”è¼ƒ

ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†å‰ã«ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ¸ˆã¿æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨ã€build ã‚¸ãƒ§ãƒ–ã§è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥å€¤ã‚’æ¯”è¼ƒã—ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‹ã©ã†ã‹æ±ºå®šã—ã¾ã™ã€‚

```yaml:deploy ã‚¸ãƒ§ãƒ–ã® if
deploy:
    if: vars.RECENT_ARTIFACTS_SHA256 != needs.build.outputs.artifacts_sha256
```

[`jobs.<job_id>.if`](https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idif) ã§ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡Œæ¡ä»¶ã‚’æŒ‡å®šã§ãã¾ã™ã€‚æ¡ä»¶å¼ãŒ `true` ã§ã‚ã‚Œã°ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œã—ã€`false` ã§ã‚ã‚Œã°ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚

`vars.RECENT_ARTIFACTS_SHA256` ã§ GitHub Actions ã® Variables ã‹ã‚‰æœ€æ–°ã®æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—ã—ã¾ã™ï¼ˆVariables ã¸ã®ä¿å­˜ã¯å¾Œè¿°ï¼‰ã€‚`needs.build.outputs.artifacts_sha256` ã§ã€build ã‚¸ãƒ§ãƒ–ã§ `GITHUB_OUTPUTS` ã¸ä¿å­˜ã—ãŸæˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å–å¾—ã—ã¦ã„ã¾ã™ã€‚

ãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸€è‡´ã—ãŸå ´åˆ(â‰’ãƒ‡ãƒ—ãƒ­ã‚¤**ä¸è¦**)ã¯ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸ä¸€è‡´ã ã£ãŸå ´åˆ(â‰’ãƒ‡ãƒ—ãƒ­ã‚¤**å¿…è¦**)ã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

## (ãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸€è‡´ã—ãŸå ´åˆ) ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦çµ‚äº†ã™ã‚‹

ç‰¹ã«ä½•ã‚‚ã›ãšã«ã‚¸ãƒ§ãƒ–ã‚’æ­£å¸¸çµ‚äº†ã—ã€å¾Œç¶šã‚¸ãƒ§ãƒ–ã‚‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚

## (ãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸ä¸€è‡´ã ã£ãŸå ´åˆ) GitHub Pages ã¸æˆæœç‰©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

GitHub Pages ã¸æˆæœç‰©ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚

## (ãƒãƒƒã‚·ãƒ¥å€¤ãŒä¸ä¸€è‡´ã ã£ãŸå ´åˆ) ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ Variables ã«ä¿å­˜ã™ã‚‹

GitHub Actions ã® Variables ã«ã€æœ€æ–°ã®æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ï¼ˆbuild ã‚¸ãƒ§ãƒ–ã§è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥å€¤ï¼‰ã‚’ä¿å­˜ã—ã¾ã™ã€‚æ¬¡å›ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«æœ€æ–°ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã§ã™ã€‚

ä¿å­˜ã«ã¯ GitHub CLI ã‚’ä½¿ã†ã®ãŒæ¯”è¼ƒçš„æ¥½ã§ã™ã€‚`gh variable set` ã‚³ãƒãƒ³ãƒ‰ã§ Variables ã‚’è¿½åŠ ãƒ»æ›´æ–°ã§ãã¾ã™ã€‚

```terminal:GitHub CLI ã§ Variables ã‚’æ›´æ–°ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
gh variable set RECENT_ARTIFACTS_SHA256 --body ${{ needs.build.outputs.artifacts_sha256 }}
```

:::message
ãªãŠã€Variables ã®æ›´æ–°ã¯ `GITHUB_TOKEN` ã®æ¨©é™ã§ã¯ã§ãã¾ã›ã‚“ã€‚
è¦æœ›ã¯ discussion ã«ä¸ŠãŒã£ã¦ã„ã¾ã™ãŒã€æ®‹å¿µãªãŒã‚‰åå¿œã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆ[Write permissions for repo variables for GITHUB_TOKEN Â· community Â· Discussion #53250](https://github.com/orgs/community/discussions/53250)ï¼‰ã€‚

GitHub Apps ã‚„ Personal Access Token ã‚’ç”¨æ„ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
åƒ•ã®å ´åˆã¯è‡ªå‰ã® GitHub Apps ã§ Repository permissions -> Variables ã« Read and Write ã‚’ä»˜ä¸ã—ã¦ã„ã¾ã™ã€‚
:::

ä¿å­˜å¾Œã¯ã€GitHub Actions ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”»é¢ã§ãƒãƒƒã‚·ãƒ¥å€¤ãŒã©ã†å¤‰åŒ–ã—ãŸã‹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã€[`GITHUB_STEP_SUMMARY`](https://docs.github.com/en/actions/using-workflows/workflow-commands-for-github-actions#adding-a-job-summary) ã«æ–°æ—§ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¿½è¨˜ã—ã¦ã„ã¾ã™ã€‚

```sh:ä¿å­˜å¾Œã®å‡¦ç†
echo "### Now changed SHA256" >> $GITHUB_STEP_SUMMARY
echo "||SHA256|" >> $GITHUB_STEP_SUMMARY
echo "|---|---|" >> $GITHUB_STEP_SUMMARY          
echo "|Old|\`${{ vars.RECENT_ARTIFACTS_SHA256 }}\`|" >> $GITHUB_STEP_SUMMARY
echo "|New|\`${{ needs.build.outputs.artifacts_sha256 }}\`|" >> $GITHUB_STEP_SUMMARY
```

![](/images/skip-deploy-by-artifact-sha-for-github-actions/now_changed_sha256.png)
*ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã® Summary ã«ã“ã‚“ãªé¢¨ã«è¡¨ç¤ºã•ã‚Œã¾ã™*

# å‰¯ç”£ç‰©

ã¡ãªã¿ã«ã€æ€ã„ã¤ã„ãŸã®ã§ã•ã‚‰ã«ã€ãƒˆãƒ”ãƒƒã‚¯ãƒ–ãƒ©ãƒ³ãƒã§ã® CI ã§ã‚‚ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã—ã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«æˆæœç‰©ã«å½±éŸ¿ãŒã‚ã‚‹ã‹ã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ©ãƒ™ãƒªãƒ³ã‚°ã™ã‚‹ã®ã‚‚ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

https://github.com/korosuke613/homepage-2nd/blob/116cfe6a44b0356934c2718868b05efcadb4c291/.github/workflows/ci.yaml#L46-L90

åƒ•ã¯ãƒˆãƒ”ãƒƒã‚¯ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒãƒ¼ã‚¸ã™ã‚‹ãŸã‚ã®æ¡ä»¶ã¨ã—ã¦ã€ãƒ“ãƒ«ãƒ‰å¯èƒ½ã‹ã©ã†ã‹ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚
ä»Šå›ã€ãƒ“ãƒ«ãƒ‰å¾Œã«ä»¥ä¸‹ã®ã“ã¨ã‚’ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

- æˆæœç‰©ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’è¨ˆç®—ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®ãƒãƒƒã‚·ãƒ¥å€¤ã¨æ¯”è¼ƒ
- æˆæœç‰©ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒ©ãƒ™ãƒ«ä»˜ã‘
- æˆæœç‰©ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ã‚’ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã‚³ãƒ¡ãƒ³ãƒˆ

![](/images/skip-deploy-by-artifact-sha-for-github-actions/pr_comment_no_changes.png)
*æˆæœç‰©ã«å¤‰æ›´ãŒ**ãªã‹ã£ãŸ**å ´åˆã¯ `No changes to the artifacts` ã¨ã‚³ãƒ¡ãƒ³ãƒˆ*

![](/images/skip-deploy-by-artifact-sha-for-github-actions/pr_comment_changes.png)
*æˆæœç‰©ã«å¤‰æ›´ãŒ**ã‚ã£ãŸ**å ´åˆã¯ `Changes to the artifacts` ã¨ã‚³ãƒ¡ãƒ³ãƒˆ*

![](/images/skip-deploy-by-artifact-sha-for-github-actions/pr_label.png)
*æˆæœç‰©ã«å¤‰æ›´ãŒãªã‹ã£ãŸå ´åˆã¯ `no changes âœ…` ã¨ãƒ©ãƒ™ãƒªãƒ³ã‚°*
*æˆæœç‰©ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã¯ `changes ğŸš¨` ã¨ãƒ©ãƒ™ãƒªãƒ³ã‚°*

æˆæœç‰©ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ã©ã†ã‹ã‚ã‹ã‚Šã‚„ã™ããªã‚Šã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒˆãƒªã‚¢ãƒ¼ã‚¸ã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¤§å¤‰ã—ã‚„ã™ããªã‚Šã¾ã—ãŸã€‚
ä»Šå›ã¯ã‚„ã£ã¦ã„ã¾ã›ã‚“ãŒã€ä»Šå¾Œã¯ã‚ªãƒ¼ãƒˆãƒãƒ¼ã‚¸ã®æ¡ä»¶ã«ã‚‚ä½¿ãˆãã†ã§ã™ã€‚

# ãŠã‚ã‚Šã«

ã‚„ã£ã¦ã¿ãŸçµæœã€åŒã˜æˆæœç‰©ã®å ´åˆã¯ã¡ã‚ƒã‚“ã¨ãƒ‡ãƒ—ãƒ­ã‚¤ä»¥é™ã®ã‚¸ãƒ§ãƒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚
**ãƒãƒªã‚‚ç©ã‚‚ã‚Œã°ãªã‚“ã¨ã‚„ã‚‰ã€‚ã“ã‚Œã§å¤šãã®ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ãƒˆãƒªã‚½ãƒ¼ã‚¹ã‚’ç¯€ç´„ã§ãã¾ã™ã­ï¼**

![](/images/skip-deploy-by-artifact-sha-for-github-actions/deploy_workflow_timeline_skipped.png)
*build ã‚¸ãƒ§ãƒ–ä»¥å¤–ãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸ*

1 ã¤æ³¨æ„ã—ãŸã„ã®ãŒã€ä»Šå›ã®æ–¹æ³•ã§ã¯ã€æˆæœç‰©ãŒåŒã˜ã§ã‚ã‚‹ã“ã¨ã‚’ä¿è¨¼ã§ãã‚‹ã®ã¯ã€**åŒã˜ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§åŒã˜æˆæœç‰©ãŒç”Ÿæˆã•ã‚Œã‚‹å ´åˆ**ã«é™ã‚‰ã‚Œã¾ã™ã€‚
ã‚‚ã—åŒã˜ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã§ã‚‚ãƒ“ãƒ«ãƒ‰ã™ã‚‹ãŸã³ã«ç•°ãªã‚‹æˆæœç‰©ãŒç”Ÿæˆã•ã‚Œã‚‹ã‚ˆã†ãªä½œã‚Šã ã¨ã€ä»Šå›ã®æ–¹æ³•ã¯ä½¿ãˆã¾ã›ã‚“ã€‚å®Ÿéš›åƒ•ã¯ãƒ“ãƒ«ãƒ‰æ™‚ã«ãƒ©ãƒ³ãƒ€ãƒ ã«å€¤ã‚’å¤‰ãˆã‚‹éƒ¨åˆ†ãŒå…ƒã€…ã‚ã£ãŸã®ã§ã€ãã†ãªã‚‰ãªã„ã‚ˆã†ãªå¯¾ç­–ã‚’äº‹å‰ã«è¡Œã„ã¾ã—ãŸã€‚

ä»Šå›ã¯é™çš„ã‚µã‚¤ãƒˆã‚’å¯¾è±¡ã«èª¬æ˜ã—ã¾ã—ãŸãŒã€åŒã˜çµæœã«ãªã‚‹ã‹ã‚’ç¢ºèªã—ã¦å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã™ã‚‹ã¨ã„ã†æ‰‹æ³•ã¯é™çš„ã‚µã‚¤ãƒˆã«é™ã‚‰ãšè‰²ã€…ãªå ´é¢ã§å½¹ç«‹ã¤ã¨æ€ã„ã¾ã™ã€‚ã¿ãªã•ã‚“ã‚‚ä½™è¨ˆãªã‚¸ãƒ§ãƒ–å®Ÿè¡Œã‚’æ¸›ã‚‰ã—ã¦ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã«ã‚„ã•ã—ã„ï¼ˆï¼Ÿï¼‰é–‹ç™ºãƒ©ã‚¤ãƒ•ã‚’é€ã£ã¦ãã ã•ã„ï¼
